#!/usr/bin/env bash
#
# usage: ./run command [argument ...]
#
# Commands for halos-metapackages development.
#

set -o nounset
set -o pipefail
set -o errexit

# Change the current directory to the project root.
PROJECT_ROOT=${0%/*}
if [[ $0 != $PROJECT_ROOT && $PROJECT_ROOT != "" ]]; then
  cd "$PROJECT_ROOT"
fi
readonly PROJECT_ROOT=$(pwd)

################################################################################
# Helper Functions

function debtools {
  #@ Run command in debtools container (Debian packaging)
  docker compose -f docker/docker-compose.debtools.yml run --rm debtools "$@"
}

################################################################################
# Debian Package Building Commands

function build-halos {
  #@ Build halos metapackage
  #@ Category: Build
  echo "üì¶ Building halos package..."
  debtools bash -c "cd halos && dpkg-buildpackage -b -uc -us && mv ../*.deb ../*.buildinfo ../*.changes ./ 2>/dev/null || true"
  echo "‚úÖ halos package built"
  ls -lh halos/*.deb 2>/dev/null || true
}

function build-halos-marine {
  #@ Build halos-marine metapackage
  #@ Category: Build
  echo "üì¶ Building halos-marine package..."
  debtools bash -c "cd halos-marine && dpkg-buildpackage -b -uc -us && mv ../*.deb ../*.buildinfo ../*.changes ./ 2>/dev/null || true"
  echo "‚úÖ halos-marine package built"
  ls -lh halos-marine/*.deb 2>/dev/null || true
}

function build-all {
  #@ Build both metapackages
  #@ Category: Build
  build-halos
  build-halos-marine
  echo ""
  echo "üì¶ All packages built:"
  ls -lh halos/*.deb halos-marine/*.deb 2>/dev/null || true
}

function lint {
  #@ Check packages with lintian (same flags as CI)
  #@ Category: Quality
  local failed=0
  echo "üîç Running lintian on halos..."
  if ! debtools lintian --info --display-info --fail-on error,warning halos/*.deb; then
    failed=1
  fi
  echo ""
  echo "üîç Running lintian on halos-marine..."
  if ! debtools lintian --info --display-info --fail-on error,warning halos-marine/*.deb; then
    failed=1
  fi
  echo ""
  if [ $failed -eq 1 ]; then
    echo "‚ùå Lintian found issues. See above for details."
    return 1
  fi
  echo "‚úÖ Lintian checks passed"
}

################################################################################
# Docker Management Commands

function build-debtools {
  #@ Build Debian packaging Docker image
  #@ Category: Docker
  echo "üê≥ Building Debian packaging Docker image..."
  docker compose -f docker/docker-compose.debtools.yml build debtools
  echo "‚úÖ Docker image built successfully"
}

function clean-debtools {
  #@ Remove Debian packaging Docker containers and images
  #@ Category: Docker
  echo "üßπ Cleaning Debian packaging Docker containers and images..."
  docker compose -f docker/docker-compose.debtools.yml down --rmi all --volumes
  echo "‚úÖ Docker cleanup complete"
}

################################################################################
# Version Management Commands

function bumpversion {
  #@ Bump version using dch (patch|minor|major) [message]
  #@ Category: Version
  local BUMP_TYPE="${1:-}"
  local MESSAGE="${2:-Version bump}"

  if [[ -z "$BUMP_TYPE" ]]; then
    echo "Error: version bump type required"
    echo "Usage: ./run bumpversion [patch|minor|major] [message]"
    exit 1
  fi

  if [[ ! "$BUMP_TYPE" =~ ^(patch|minor|major)$ ]]; then
    echo "Error: invalid bump type '$BUMP_TYPE'"
    echo "Usage: ./run bumpversion [patch|minor|major] [message]"
    exit 1
  fi

  # Check for clean working directory
  if ! git diff --quiet || ! git diff --cached --quiet; then
    echo "Error: working directory not clean"
    echo "Commit or stash changes before bumping version"
    exit 1
  fi

  # Read current version
  local CURRENT_VERSION
  CURRENT_VERSION=$(cat VERSION)
  echo "Current version: $CURRENT_VERSION"

  # Calculate new version
  local IFS='.'
  read -ra VERSION_PARTS <<< "$CURRENT_VERSION"
  local MAJOR="${VERSION_PARTS[0]}"
  local MINOR="${VERSION_PARTS[1]}"
  local PATCH="${VERSION_PARTS[2]}"

  case "$BUMP_TYPE" in
    major)
      MAJOR=$((MAJOR + 1))
      MINOR=0
      PATCH=0
      ;;
    minor)
      MINOR=$((MINOR + 1))
      PATCH=0
      ;;
    patch)
      PATCH=$((PATCH + 1))
      ;;
  esac

  local NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
  echo "New version: $NEW_VERSION"

  # Update VERSION file
  echo "$NEW_VERSION" > VERSION

  # Update both changelogs using dch in debtools container
  echo "Updating changelogs using dch..."

  debtools bash -c "
    export DEBEMAIL='info@hatlabs.fi'
    export DEBFULLNAME='Hat Labs'

    cd halos && dch --newversion '${NEW_VERSION}-1' --distribution unstable '$MESSAGE'
    cd ../halos-marine && dch --newversion '${NEW_VERSION}-1' --distribution unstable '$MESSAGE'
  "

  echo "Committing changes..."

  # Commit the changes (bypass changelog check since we used dch)
  git add VERSION halos/debian/changelog halos-marine/debian/changelog
  SKIP_CHANGELOG_CHECK=1 git commit -m "chore: bump version to ${NEW_VERSION}

${MESSAGE}"

  echo ""
  echo "‚úÖ Version bumped to $NEW_VERSION"
  echo "Push with: git push"
}

################################################################################
# Development Commands

function install-hooks {
  #@ Install pre-commit hooks using lefthook
  #@ Category: Development
  if ! command -v lefthook &> /dev/null; then
    echo "Error: lefthook not found. Install with: brew install lefthook"
    exit 1
  fi
  lefthook install
  echo "‚úÖ Pre-commit hooks installed"
}

function run-hooks {
  #@ Run pre-commit hooks manually
  #@ Category: Development
  if ! command -v lefthook &> /dev/null; then
    echo "Error: lefthook not found. Install with: brew install lefthook"
    exit 1
  fi
  lefthook run pre-commit
}

################################################################################
# Utility Commands

function clean {
  #@ Clean build artifacts
  #@ Category: Utility
  echo "üßπ Cleaning build artifacts..."
  rm -f halos/*.deb halos/*.buildinfo halos/*.changes 2>/dev/null || true
  rm -f halos-marine/*.deb halos-marine/*.buildinfo halos-marine/*.changes 2>/dev/null || true
  echo "‚úÖ Cleanup complete"
}

################################################################################
# Help System

function help {
  #@ Show this help message
  #@ Category: Core
  echo "HaLOS Metapackages - Development Commands"
  echo "=========================================="
  echo ""
  echo "Available commands:"
  echo ""

  # Extract function definitions and their help comments
  awk '/^function / {
    fname = $2
    sub(/[({].*/, "", fname)
    getline
    if ($0 ~ /#@/) {
      desc = $0
      sub(/.*#@ /, "", desc)
      sub(/ *$/, "", desc)
      getline
      if ($0 ~ /#@ Category:/) {
        cat = $0
        sub(/.*Category: /, "", cat)
        sub(/ *$/, "", cat)
        if (!seen[cat]++) categories[++cat_count] = cat
        commands[cat, ++cmd_count[cat]] = fname
        descriptions[cat, cmd_count[cat]] = desc
      }
    }
  }
  END {
    for (i = 1; i <= cat_count; i++) {
      cat = categories[i]
      print "\n" cat ":"
      for (j = 1; j <= cmd_count[cat]; j++) {
        printf "  %-25s %s\n", commands[cat, j], descriptions[cat, j]
      }
    }
  }' "$0"

  echo ""
  echo "Usage: ./run <command> [arguments...]"
  echo ""
}

################################################################################
# Commands end.

TIMEFORMAT=$'\nTask completed in %3lR'
time "${@:-help}"
